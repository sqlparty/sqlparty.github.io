---
layout: post
status: publish
published: true
title: 将包含额外信息的连续记录添加到上一条记录中
author:
  display_name: super
  login: super
  email: sqlparty@gmail.com
  url: ''
author_login: super
author_email: sqlparty@gmail.com
excerpt: "从其他地方获取到比较完整的行业分类信息，导入到MySQL数据库表gbt中，结构与数据情况如下图所示：\r\n[sql]\r\n+------+------+------+------+------+-------------------------+-----------------------------------------------+\r\n|
  id   | c1   | c2   | c3   | c4   | name                    | description                                   |\r\n+------+------+------+------+------+-------------------------+-----------------------------------------------+\r\n|
  \   1 | A    |      |      |      | 农、林、牧、渔业        |  本门类包括01～05大类                         |\r\n|
  \   2 |      | 1    |      |      | 农业                    |  指对各种农作物的种植                         |\r\n|
  \   3 |      |      | 11   |      |  谷物种植               |  指以收获籽实为主，供人类食用的农作物的种
  \    |\r\n|    4 |      |      |      |      |                         | 植，如稻谷、小麦、玉米等农作物的种植
  \         |\r\n|    5 |      |      |      | 111  |    稻谷种植             |                                               |\r\n|
  \   6 |      |      |      | 112  |    小麦种植             |                                               |\r\n|
  \   7 |      |      |      | 113  |    玉米种植             |                                               |\r\n|
  \   8 |      |      |      | 119  |    其他谷物种植         |                                               |\r\n|
  \   9 |      |      | 12   |      |  豆类、油料和薯类种植   |                                               |\r\n|
  \  10 |      |      |      | 121  |    豆类种植             |                                               |\r\n...(省略一部分)
  \                                                                                            \r\n|
  \  87 |      |      |      | 512  |    灌溉服务             |  指对农业生产灌溉系统的经营与管理             |\r\n|
  \  88 |      |      |      | 513  |    农产品初加工服务     |  指对各种农产品（包括天然橡胶、纺织纤维原     |\r\n|
  \  89 |      |      |      |      |                         | 料）进行脱水、凝固、去籽、净化、分类、晒干
  \   |\r\n|   90 |      |      |      |      |                         | 、剥皮、初烤、沤软或大批包装以提供初级市场
  \   |\r\n|   91 |      |      |      |      |                         | 的服务，以及其他农产品的初加工；其中棉花等
  \   |\r\n|   92 |      |      |      |      |                         | 纺织纤维原料加工指对棉纤维、短绒剥离后的棉
  \   |\r\n|   93 |      |      |      |      |                         | 籽以及棉花秸秆、铃壳等副产品的综合加工和利
  \   |\r\n|   94 |      |      |      |      |                         | 用活动                                        |\r\n|
  \  95 |      |      |      | 519  |    其他农业服务         |  指防止病虫害的活动，以及其他未列明的农业     |\r\n|
  \  96 |      |      |      |      |                         | 服务                                          |\r\n|
  \  97 |      |      | 52   |      |  林业服务业             |  指为林业生产服务的病虫害的防治、林地防火     |\r\n|
  \  98 |      |      |      |      |                         | 等各种辅助性活动                              |\r\n...(省略一部分)
  \                                                                                            \r\n|
  2672 |      |      |      | 7296 |  担保服务               |  指保证人和债权人约定，当债务人不履行债务     |\r\n|
  2673 |      |      |      |      |                         | 时，保证人按照约定履行债务或者承担责任的行
  \   |\r\n| 2674 |      |      |      |      |                         | 为活动；本类别特指专业担保机构的活动
  \         |\r\n| 2675 |      |      |      | 7299 |  其他未列明商务服务业   |  指上述未列明的商务、代理等活动
  \              |\r\n| 2676 | T    |      |      |      | 国际组织                |  本门类包括96大类
  \                            |\r\n| 2677 |      | 96   |      |      | 国际组织                |
  \                                              |\r\n| 2678 |      |      | 960  |
  9600 |  国际组织               |  指联合国和其他国际组织驻我国境内机构等的     |\r\n| 2679 |      |      |
  \     |      |                         | 活动                                          |\r\n+------+------+------+------+------+-------------------------+-----------------------------------------------+\r\n[/sql]\r\n\r\n可以看到，行业分类被划分成4个层次，按照深度优先的规则顺序排列，id是连续、递增的序号。\r\n\r\n不难发现这些数据中存在这样的问题：\r\n\r\n有些记录没有4个层次分类c1,c2,c3,c4的内容，只有name或者description信息。也很容易判断，这些信息是紧邻的分类信息的补充内容，即原本应该一条记录的内容，被&ldquo;换行&rdquo;保存成了多条，如这里的多条：\r\n[sql]\r\n|
  \  88 |      |      |      | 513  |    农产品初加工服务     |  指对各种农产品（包括天然橡胶、纺织纤维原                       |\r\n|
  \  89 |      |      |      |      |                         | 料）进行脱水、凝固、去籽、净化、分类、晒干
  \                     |\r\n|   90 |      |      |      |      |                         |
  、剥皮、初烤、沤软或大批包装以提供初级市场                      |\r\n|   91 |      |      |      |      |
  \                        | 的服务，以及其他农产品的初加工；其中棉花等                      |\r\n|   92
  |      |      |      |      |                         | 纺织纤维原料加工指对棉纤维、短绒剥离后的棉                      |\r\n|
  \  93 |      |      |      |      |                         | 籽以及棉花秸秆、铃壳等副产品的综合加工和利
  \                     |\r\n|   94 |      |      |      |      |                         |
  用活动                                                          |\r\n[/sql]\r\n\r\n应该被保存为一条：\r\n[sql]\r\n|
  \  88 |      |      |      | 513  |    农产品初加工服务     |  指对各种农产品（包括天然橡胶、纺织纤维原料）进行脱水、凝固、去籽、净化、分类、晒干、剥皮、初烤、沤软或大批包装以提供初级市场的服务，以及其他农产品的初加工；其中棉花等纺织纤维原料加工指对棉纤维、短绒剥离后的棉籽以及棉花秸秆、铃壳等副产品的综合加工和利用活动
  \   |\r\n[/sql]\r\n\r\n其他编号89-94的记录应删除。\r\n\r\n使用SQL实现如上需求，如何实现？\r\n\r\n"
wordpress_id: 721
wordpress_url: http://www.sqlparty.com/?p=721
date: '2013-09-27 22:47:14 +0800'
date_gmt: '2013-09-27 14:47:14 +0800'
categories:
- 题炼
tags:
- MySQL
---
<p>从其他地方获取到比较完整的行业分类信息，导入到MySQL数据库表gbt中，结构与数据情况如下图所示：<br />
[sql]<br />
+------+------+------+------+------+-------------------------+-----------------------------------------------+<br />
| id   | c1   | c2   | c3   | c4   | name                    | description                                   |<br />
+------+------+------+------+------+-------------------------+-----------------------------------------------+<br />
|    1 | A    |      |      |      | 农、林、牧、渔业        |  本门类包括01～05大类                         |<br />
|    2 |      | 1    |      |      | 农业                    |  指对各种农作物的种植                         |<br />
|    3 |      |      | 11   |      |  谷物种植               |  指以收获籽实为主，供人类食用的农作物的种     |<br />
|    4 |      |      |      |      |                         | 植，如稻谷、小麦、玉米等农作物的种植          |<br />
|    5 |      |      |      | 111  |    稻谷种植             |                                               |<br />
|    6 |      |      |      | 112  |    小麦种植             |                                               |<br />
|    7 |      |      |      | 113  |    玉米种植             |                                               |<br />
|    8 |      |      |      | 119  |    其他谷物种植         |                                               |<br />
|    9 |      |      | 12   |      |  豆类、油料和薯类种植   |                                               |<br />
|   10 |      |      |      | 121  |    豆类种植             |                                               |<br />
...(省略一部分)<br />
|   87 |      |      |      | 512  |    灌溉服务             |  指对农业生产灌溉系统的经营与管理             |<br />
|   88 |      |      |      | 513  |    农产品初加工服务     |  指对各种农产品（包括天然橡胶、纺织纤维原     |<br />
|   89 |      |      |      |      |                         | 料）进行脱水、凝固、去籽、净化、分类、晒干    |<br />
|   90 |      |      |      |      |                         | 、剥皮、初烤、沤软或大批包装以提供初级市场    |<br />
|   91 |      |      |      |      |                         | 的服务，以及其他农产品的初加工；其中棉花等    |<br />
|   92 |      |      |      |      |                         | 纺织纤维原料加工指对棉纤维、短绒剥离后的棉    |<br />
|   93 |      |      |      |      |                         | 籽以及棉花秸秆、铃壳等副产品的综合加工和利    |<br />
|   94 |      |      |      |      |                         | 用活动                                        |<br />
|   95 |      |      |      | 519  |    其他农业服务         |  指防止病虫害的活动，以及其他未列明的农业     |<br />
|   96 |      |      |      |      |                         | 服务                                          |<br />
|   97 |      |      | 52   |      |  林业服务业             |  指为林业生产服务的病虫害的防治、林地防火     |<br />
|   98 |      |      |      |      |                         | 等各种辅助性活动                              |<br />
...(省略一部分)<br />
| 2672 |      |      |      | 7296 |  担保服务               |  指保证人和债权人约定，当债务人不履行债务     |<br />
| 2673 |      |      |      |      |                         | 时，保证人按照约定履行债务或者承担责任的行    |<br />
| 2674 |      |      |      |      |                         | 为活动；本类别特指专业担保机构的活动          |<br />
| 2675 |      |      |      | 7299 |  其他未列明商务服务业   |  指上述未列明的商务、代理等活动               |<br />
| 2676 | T    |      |      |      | 国际组织                |  本门类包括96大类                             |<br />
| 2677 |      | 96   |      |      | 国际组织                |                                               |<br />
| 2678 |      |      | 960  | 9600 |  国际组织               |  指联合国和其他国际组织驻我国境内机构等的     |<br />
| 2679 |      |      |      |      |                         | 活动                                          |<br />
+------+------+------+------+------+-------------------------+-----------------------------------------------+<br />
[/sql]</p>
<p>可以看到，行业分类被划分成4个层次，按照深度优先的规则顺序排列，id是连续、递增的序号。</p>
<p>不难发现这些数据中存在这样的问题：</p>
<p>有些记录没有4个层次分类c1,c2,c3,c4的内容，只有name或者description信息。也很容易判断，这些信息是紧邻的分类信息的补充内容，即原本应该一条记录的内容，被&ldquo;换行&rdquo;保存成了多条，如这里的多条：<br />
[sql]<br />
|   88 |      |      |      | 513  |    农产品初加工服务     |  指对各种农产品（包括天然橡胶、纺织纤维原                       |<br />
|   89 |      |      |      |      |                         | 料）进行脱水、凝固、去籽、净化、分类、晒干                      |<br />
|   90 |      |      |      |      |                         | 、剥皮、初烤、沤软或大批包装以提供初级市场                      |<br />
|   91 |      |      |      |      |                         | 的服务，以及其他农产品的初加工；其中棉花等                      |<br />
|   92 |      |      |      |      |                         | 纺织纤维原料加工指对棉纤维、短绒剥离后的棉                      |<br />
|   93 |      |      |      |      |                         | 籽以及棉花秸秆、铃壳等副产品的综合加工和利                      |<br />
|   94 |      |      |      |      |                         | 用活动                                                          |<br />
[/sql]</p>
<p>应该被保存为一条：<br />
[sql]<br />
|   88 |      |      |      | 513  |    农产品初加工服务     |  指对各种农产品（包括天然橡胶、纺织纤维原料）进行脱水、凝固、去籽、净化、分类、晒干、剥皮、初烤、沤软或大批包装以提供初级市场的服务，以及其他农产品的初加工；其中棉花等纺织纤维原料加工指对棉纤维、短绒剥离后的棉籽以及棉花秸秆、铃壳等副产品的综合加工和利用活动    |<br />
[/sql]</p>
<p>其他编号89-94的记录应删除。</p>
<p>使用SQL实现如上需求，如何实现？</p>
<p><!--more--></p>
<p>分析上面的场景，需要处理的记录具有这样的特征：</p>
<ol>
<li>c1,c2,c3,c4字段都为空的记录最终需要被删除；</li>
<li>这些要被删除的记录，编号连续的，编为一组；</li>
<li>这些记录，应按照id从小到大顺序，将name和description添加到邻近的（较小id的）具有层级信息的记录的name和description上；</li><br />
</ol><br />
筛选出这些要删除的记录，可以使用<span style="color: #0000ff;">c1='' and c2='' and c3='' and c4=''</span>，但是由于每个字段可能有前后空格，每个字段进行trim的话稍显繁琐。</p>
<p>简单一点可以如下处理：<span style="color: #0000ff;">trim(concat(c1,c2,c3,c4))=''</span>。</p>
<p>将连续编号的记录化归到一组，有点熟悉，想起了这个<a title="有趣的查询：查询连续七天登录的用户(实现MySQL下的row_number)" href="http://www.sqlparty.com/%e6%9c%89%e8%b6%a3%e7%9a%84%e6%9f%a5%e8%af%a2%ef%bc%9a%e6%9f%a5%e8%af%a2%e8%bf%9e%e7%bb%ad%e4%b8%83%e5%a4%a9%e7%99%bb%e5%bd%95%e7%9a%84%e7%94%a8%e6%88%b7/" target="_blank">有趣的查询。</a>可以参考它的实现。</p>
<p>而分组后就可以将这些字段的name,description拼接起来了，注意拼接的顺序是按照id升序。MySQL中可以使用group_concat(... order by ...)。而每个分组的min(id)-1就是我们要添加到的那条记录。</p>
<p>综合以上考虑，我们可以在一个SQL中实现添加到上一条记录的需求：</p>
<p>[sql]<br />
update gbt t1,<br />
(<br />
       select id-num as groupno<br />
             ,min(id)-1 as target_id<br />
             ,group_concat( trim(name) ORDER BY id SEPARATOR '' ) as name_to_append<br />
             ,group_concat( trim(description) ORDER BY id SEPARATOR '' ) as description_to_append<br />
       from<br />
      (<br />
             select t1.*,@num:=@num+1 as num<br />
             from gbt t1,(select @num:=1) t2<br />
             where trim (concat(c1,c2,c3,c4))=''<br />
             order by id<br />
      ) A<br />
       group by id-num<br />
) t2<br />
set t1.name = concat(trim(t1.name),t2.name_to_append),<br />
    t1.description = concat(trim (t1.description),t2.description_to_append)<br />
where t1.id = t2.target_id<br />
;</p>
<p>[/sql]</p>
<p>当然，最后不要忘了删除这些额外的记录：</p>
<p>[sql]<br />
delete from  gbt where trim(concat(c1,c2,c3,c4))='';<br />
[/sql]</p>
